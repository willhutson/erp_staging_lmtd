// SpokeStack ERP - Social Media Buying & Listening Module
// Prisma Schema v1.1 (Standardized)
//
// This schema extends the existing TeamLMTD ERP with CRM, Creator,
// and Campaign management capabilities.
//
// Changes from v1.0:
// - Renamed orgId → organizationId for consistency with main ERP
// - Added missing indexes on junction tables
// - Added isActive flags for soft delete support
// - Fixed Contact.email unique constraint for nullable emails

// NOTE: This file is for reference. These models should be merged into
// the main schema.prisma file when implementing.

// ═══════════════════════════════════════════════════════════════════════════
// MULTI-TENANCY LAYER (Extended)
// ═══════════════════════════════════════════════════════════════════════════

// The Organization model in main schema should be extended with:
// - type: OrgType field
// - parentId/parent/children for hierarchy
// - Additional relations for CRM entities

enum OrgType {
  PLATFORM  // SpokeStack system level
  AGENCY    // Marketing agencies (e.g., LMTD)
  BRAND     // End clients managed by agencies
}

model OrganizationMember {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  role            MemberRole   @default(MEMBER)
  permissions     String[]     // Granular permission overrides

  invitedBy       String?
  invitedAt       DateTime?
  joinedAt        DateTime     @default(now())
  isActive        Boolean      @default(true)

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

enum MemberRole {
  OWNER   // Full access, can delete org
  ADMIN   // Full access except billing/deletion
  MEMBER  // Standard access
  VIEWER  // Read-only access
}

// ═══════════════════════════════════════════════════════════════════════════
// CRM CORE ENTITIES
// ═══════════════════════════════════════════════════════════════════════════

model CrmCompany {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identity
  name            String
  legalName       String?
  industry        String?
  website         String?
  logo            String?

  // Classification
  size            CompanySize?
  type            CompanyType  @default(PROSPECT)

  // Contact info
  email           String?
  phone           String?

  // Address
  address         String?
  city            String?
  state           String?
  country         String?
  postalCode      String?

  // Social
  linkedinUrl     String?
  twitterHandle   String?

  // Relations
  contacts        CrmContact[]
  deals           CrmDeal[]

  // Metadata
  tags            String[]
  customFields    Json      @default("{}")

  // Soft delete
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([organizationId, name])
  @@index([type])
  @@map("crm_companies")
}

enum CompanySize {
  SOLO        // 1 person
  SMALL       // 2-10
  MEDIUM      // 11-50
  LARGE       // 51-200
  ENTERPRISE  // 200+
}

enum CompanyType {
  PROSPECT
  CLIENT
  PARTNER
  VENDOR
  COMPETITOR
}

model CrmContact {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companyId       String?
  company         CrmCompany? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Identity
  firstName       String
  lastName        String
  email           String?
  phone           String?
  mobile          String?
  avatar          String?

  // Professional
  title           String?
  department      String?

  // Classification
  type            ContactType   @default(LEAD)
  status          ContactStatus @default(ACTIVE)
  source          String?       // How they found you (referral, website, event, etc.)

  // Social (for non-creator contacts)
  linkedinUrl     String?
  twitterHandle   String?

  // CRM Relations
  deals           CrmDeal[]
  tasks           CrmTask[]
  notes           CrmNote[]
  activities      CrmActivity[]

  // Creator extension (nullable - not all contacts are creators)
  creator         Creator?

  // Owner/Assignment
  ownerId         String?
  owner           User?    @relation("ContactOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Metadata
  tags            String[]
  customFields    Json      @default("{}")

  // Soft delete
  isActive        Boolean   @default(true)

  lastContactedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Note: Removed unique constraint on email since it can be null
  // Use application-level validation for duplicate emails within org
  @@index([organizationId])
  @@index([organizationId, email])
  @@index([companyId])
  @@index([type])
  @@index([status])
  @@index([ownerId])
  @@map("crm_contacts")
}

enum ContactType {
  LEAD
  PROSPECT
  CLIENT
  PARTNER
  CREATOR
  VENDOR
  OTHER
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  CHURNED
  DO_NOT_CONTACT
}

model CrmDeal {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  companyId       String?
  company         CrmCompany? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  // Deal info
  name            String
  description     String?  @db.Text

  // Pipeline
  stage           DealStage @default(LEAD)
  probability     Int       @default(0)  // 0-100

  // Value
  amount          Decimal?  @db.Decimal(12, 2)
  currency        String    @default("USD")
  recurringType   RecurringType?

  // Dates
  expectedClose   DateTime?
  actualClose     DateTime?

  // Outcome
  status          DealStatus @default(OPEN)
  lostReason      String?
  wonReason       String?

  // Owner/Assignment
  ownerId         String?
  owner           User?    @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Relations
  tasks           CrmTask[]
  notes           CrmNote[]
  activities      CrmActivity[]
  campaigns       SocialCampaign[]

  // Metadata
  tags            String[]
  customFields    Json      @default("{}")

  // Soft delete
  isActive        Boolean   @default(true)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([stage])
  @@index([status])
  @@index([ownerId])
  @@index([expectedClose])
  @@map("crm_deals")
}

enum DealStage {
  LEAD
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CLOSED
}

enum DealStatus {
  OPEN
  WON
  LOST
}

enum RecurringType {
  ONE_TIME
  MONTHLY
  QUARTERLY
  ANNUAL
}

model CrmTask {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  dealId          String?
  deal            CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

  // Task details
  title           String
  description     String?  @db.Text

  // Scheduling
  dueDate         DateTime?
  reminderAt      DateTime?

  // Status
  completed       Boolean  @default(false)
  completedAt     DateTime?
  priority        CrmPriority @default(MEDIUM)

  // Assignment
  assignedToId    String?
  assignedTo      User?    @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  createdById     String
  createdBy       User     @relation("TaskCreator", fields: [createdById], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([assignedToId])
  @@index([dueDate])
  @@index([completed])
  @@index([contactId])
  @@index([dealId])
  @@map("crm_tasks")
}

enum CrmPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model CrmNote {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  dealId          String?
  deal            CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

  // Content
  content         String   @db.Text

  // Email capture (for CC-to-CRM feature)
  isEmail         Boolean  @default(false)
  emailFrom       String?
  emailTo         String[]
  emailCc         String[]
  emailSubject    String?
  emailDate       DateTime?
  emailMessageId  String?

  // Attachments
  attachments     Json[]   @default([])  // [{name, url, size, type}]

  // Author
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])

  // Visibility
  isPrivate       Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([contactId])
  @@index([dealId])
  @@index([authorId])
  @@map("crm_notes")
}

// Unified activity log for timeline views
model CrmActivity {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contactId       String?
  contact         CrmContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  dealId          String?
  deal            CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

  // Actor
  actorId         String
  actor           User     @relation(fields: [actorId], references: [id])

  // Activity details
  type            CrmActivityType
  description     String
  metadata        Json     @default("{}")  // Additional context

  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([contactId])
  @@index([dealId])
  @@index([actorId])
  @@index([type])
  @@index([createdAt])
  @@map("crm_activities")
}

enum CrmActivityType {
  // Contact activities
  CONTACT_CREATED
  CONTACT_UPDATED
  CONTACT_DELETED
  CONTACT_MERGED

  // Company activities
  COMPANY_CREATED
  COMPANY_UPDATED

  // Deal activities
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_STAGE_CHANGED
  DEAL_WON
  DEAL_LOST

  // Task activities
  TASK_CREATED
  TASK_COMPLETED
  TASK_OVERDUE

  // Note activities
  NOTE_ADDED
  EMAIL_RECEIVED
  EMAIL_SENT

  // Campaign activities
  CAMPAIGN_LAUNCHED
  CAMPAIGN_PAUSED
  CAMPAIGN_COMPLETED

  // Creator activities
  CREATOR_SIGNED
  PLATFORM_CONNECTED
  CONTENT_PUBLISHED
}

// ═══════════════════════════════════════════════════════════════════════════
// CREATOR MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════

model Creator {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to base contact
  contactId       String   @unique
  contact         CrmContact  @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // Representation status
  status          CreatorStatus @default(PROSPECT)

  // Contract details
  commissionRate  Decimal? @db.Decimal(4, 2)  // e.g., 15.00 = 15%
  contractStart   DateTime?
  contractEnd     DateTime?
  exclusivityType ExclusivityType?

  // Phyllo integration
  phylloUserId    String?  @unique

  // Aggregated metrics (synced from platforms)
  totalFollowers      Int      @default(0)
  avgEngagementRate   Decimal? @db.Decimal(5, 4)  // e.g., 0.0325 = 3.25%
  primaryPlatform     SocialPlatform?
  estimatedReach      Int?

  // Content categories
  categories      String[]  // e.g., ["fashion", "lifestyle", "travel"]

  // Relations
  platforms       CreatorPlatform[]
  campaigns       CampaignCreator[]
  content         CreatorContent[]

  // Metadata
  notes           String?  @db.Text
  customFields    Json     @default("{}")

  // Soft delete
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([totalFollowers])
  @@index([primaryPlatform])
  @@map("creators")
}

enum CreatorStatus {
  PROSPECT      // Identified, not contacted
  OUTREACH      // In contact/negotiation
  NEGOTIATION   // Contract discussions
  SIGNED        // Active representation
  INACTIVE      // Paused/ended relationship
}

enum ExclusivityType {
  NONE
  CATEGORY      // Exclusive within category
  PLATFORM      // Exclusive on specific platform
  FULL          // Full exclusivity
}

model CreatorPlatform {
  id              String   @id @default(cuid())
  creatorId       String
  creator         Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Platform identity
  platform        SocialPlatform
  handle          String
  platformUserId  String?  // Native platform user ID
  profileUrl      String?

  // Metrics (updated via Phyllo sync)
  followers       Int      @default(0)
  following       Int?
  engagementRate  Decimal? @db.Decimal(5, 4)
  avgViews        Int?
  avgLikes        Int?
  avgComments     Int?
  postsCount      Int?

  // Audience demographics (JSON blob from Phyllo)
  audienceDemo    Json?    // {age_ranges, genders, countries, cities}

  // Connection status
  phylloAccountId String?  @unique
  isConnected     Boolean  @default(false)
  connectedAt     DateTime?
  lastSyncAt      DateTime?
  syncError       String?

  // Verification
  isVerified      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([creatorId, platform])
  @@index([platform])
  @@index([followers])
  @@index([creatorId])
  @@map("creator_platforms")
}

enum SocialPlatform {
  INSTAGRAM
  TIKTOK
  YOUTUBE
  TWITTER
  LINKEDIN
  SNAPCHAT
  PINTEREST
  TWITCH
  FACEBOOK
}

// ═══════════════════════════════════════════════════════════════════════════
// AD ACCOUNT MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════

model AdAccount {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Platform identity
  platform        AdPlatform
  accountId       String   // Platform's native account ID
  accountName     String?

  // Hierarchy (for agency structures)
  parentId        String?
  parent          AdAccount? @relation("AdAccountHierarchy", fields: [parentId], references: [id])
  children        AdAccount[] @relation("AdAccountHierarchy")
  isAgencyAccount Boolean  @default(false)

  // OAuth tokens (encrypted)
  accessTokenEncrypted   String?
  refreshTokenEncrypted  String?
  tokenExpiresAt         DateTime?
  tokenScopes            String[]

  // Connection metadata
  connected       Boolean  @default(false)
  connectedById   String?
  connectedBy     User?    @relation(fields: [connectedById], references: [id], onDelete: SetNull)
  connectedAt     DateTime?

  // Sync status
  lastSyncAt      DateTime?
  syncStatus      SyncStatus @default(PENDING)
  syncError       String?

  // Spend limits (for alerting)
  dailyBudgetLimit   Decimal? @db.Decimal(10, 2)
  monthlyBudgetLimit Decimal? @db.Decimal(12, 2)

  // Relations
  campaigns       CampaignAdAccount[]
  metrics         CampaignMetric[]

  // Soft delete
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([platform, accountId])
  @@index([organizationId])
  @@index([platform])
  @@index([connected])
  @@index([parentId])
  @@map("ad_accounts")
}

enum AdPlatform {
  META        // Facebook & Instagram
  GOOGLE      // Google Ads (Search, Display, YouTube)
  TIKTOK
  SNAPCHAT
  LINKEDIN
  TWITTER
  PINTEREST
  AMAZON      // Amazon Ads
  DV360       // Google Display & Video 360
}

enum SyncStatus {
  PENDING
  SYNCING
  SUCCESS
  ERROR
  PAUSED
}

// ═══════════════════════════════════════════════════════════════════════════
// CAMPAIGN MANAGEMENT
// ═══════════════════════════════════════════════════════════════════════════

model SocialCampaign {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Link to CRM deal
  dealId          String?
  deal            CrmDeal?    @relation(fields: [dealId], references: [id], onDelete: SetNull)

  // Campaign details
  name            String
  description     String?  @db.Text
  objective       CampaignObjective?

  // Status
  status          CampaignStatus @default(DRAFT)

  // Budget
  budget          Decimal? @db.Decimal(12, 2)
  currency        String   @default("USD")

  // Timeline
  startDate       DateTime?
  endDate         DateTime?

  // Aggregated performance (synced from BigQuery)
  totalSpend      Decimal  @default(0) @db.Decimal(12, 2)
  impressions     BigInt   @default(0)
  clicks          Int      @default(0)
  conversions     Int      @default(0)
  reach           BigInt?
  frequency       Decimal? @db.Decimal(4, 2)

  // Calculated metrics
  cpm             Decimal? @db.Decimal(8, 4)
  cpc             Decimal? @db.Decimal(8, 4)
  ctr             Decimal? @db.Decimal(6, 4)
  cpa             Decimal? @db.Decimal(10, 4)
  roas            Decimal? @db.Decimal(8, 4)

  // Relations
  creators        CampaignCreator[]
  adAccounts      CampaignAdAccount[]
  metrics         CampaignMetric[]
  content         CreatorContent[]

  // Metadata
  tags            String[]
  customFields    Json     @default("{}")

  // Soft delete
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([dealId])
  @@index([startDate])
  @@map("social_campaigns")
}

enum CampaignObjective {
  AWARENESS
  REACH
  TRAFFIC
  ENGAGEMENT
  APP_INSTALLS
  VIDEO_VIEWS
  LEAD_GENERATION
  CONVERSIONS
  CATALOG_SALES
  STORE_TRAFFIC
}

enum CampaignStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Junction table: Campaign ↔ Creator
model CampaignCreator {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        SocialCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creatorId       String
  creator         Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Role in campaign
  role            CreatorRole @default(PRIMARY)

  // Compensation
  feeAmount       Decimal? @db.Decimal(10, 2)
  feeType         FeeType  @default(FLAT)

  // Deliverables
  deliverables    Json     @default("{}")  // {posts: 3, stories: 5, reels: 2}

  // Status
  status          CreatorCampaignStatus @default(PENDING)
  briefSentAt     DateTime?
  acceptedAt      DateTime?
  completedAt     DateTime?

  // Performance (attributed)
  impressions     BigInt?
  engagements     Int?
  clicks          Int?
  conversions     Int?

  // Notes
  notes           String?  @db.Text

  @@unique([campaignId, creatorId])
  @@index([campaignId])
  @@index([creatorId])
  @@index([status])
  @@map("campaign_creators")
}

enum CreatorRole {
  PRIMARY
  SUPPORTING
  AFFILIATE
  UGC
}

enum FeeType {
  FLAT
  CPM
  CPC
  CPA
  REVENUE_SHARE
  HYBRID
}

enum CreatorCampaignStatus {
  PENDING
  INVITED
  ACCEPTED
  IN_PROGRESS
  SUBMITTED
  APPROVED
  COMPLETED
  DECLINED
  CANCELLED
}

// Junction table: Campaign ↔ Ad Account
model CampaignAdAccount {
  id                  String   @id @default(cuid())
  campaignId          String
  campaign            SocialCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adAccountId         String
  adAccount           AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  // Platform-specific campaign reference
  platformCampaignId  String?
  platformCampaignUrl String?

  // Budget allocation (optional)
  allocatedBudget     Decimal? @db.Decimal(12, 2)

  // Status
  status              AdCampaignStatus @default(NOT_STARTED)

  @@unique([campaignId, adAccountId])
  @@index([campaignId])
  @@index([adAccountId])
  @@map("campaign_ad_accounts")
}

enum AdCampaignStatus {
  NOT_STARTED
  SETTING_UP
  ACTIVE
  PAUSED
  ENDED
  ERROR
}

// Daily metrics (synced from BigQuery)
model CampaignMetric {
  id              String   @id @default(cuid())
  campaignId      String
  campaign        SocialCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adAccountId     String
  adAccount       AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)
  date            DateTime @db.Date

  // Core metrics
  spend           Decimal  @db.Decimal(10, 2)
  impressions     BigInt
  clicks          Int
  conversions     Int

  // Reach & frequency
  reach           BigInt?
  frequency       Decimal? @db.Decimal(4, 2)

  // Calculated metrics
  cpm             Decimal? @db.Decimal(8, 4)
  cpc             Decimal? @db.Decimal(8, 4)
  ctr             Decimal? @db.Decimal(6, 4)
  cpa             Decimal? @db.Decimal(10, 4)
  roas            Decimal? @db.Decimal(8, 4)

  // Video metrics (if applicable)
  videoViews      BigInt?
  videoViews25    BigInt?
  videoViews50    BigInt?
  videoViews75    BigInt?
  videoViews100   BigInt?

  // Platform-specific metrics (JSON blob)
  platformData    Json     @default("{}")

  syncedAt        DateTime @default(now())

  @@unique([campaignId, adAccountId, date])
  @@index([date])
  @@index([campaignId, date])
  @@index([adAccountId])
  @@map("campaign_metrics")
}

// ═══════════════════════════════════════════════════════════════════════════
// CREATOR CONTENT TRACKING
// ═══════════════════════════════════════════════════════════════════════════

model CreatorContent {
  id              String   @id @default(cuid())
  creatorId       String
  creator         Creator  @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  platformId      String   // CreatorPlatform.id

  // Content identity
  platform        SocialPlatform
  contentId       String   // Platform's native content ID
  contentType     ContentType
  contentUrl      String?

  // Metadata
  caption         String?  @db.Text
  hashtags        String[]
  mentions        String[]
  thumbnailUrl    String?

  // Metrics (updated via sync)
  views           BigInt?
  likes           Int?
  comments        Int?
  shares          Int?
  saves           Int?
  engagementRate  Decimal? @db.Decimal(6, 4)

  // Campaign attribution
  campaignId      String?
  campaign        SocialCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  publishedAt     DateTime
  syncedAt        DateTime @default(now())

  @@unique([platform, contentId])
  @@index([creatorId])
  @@index([campaignId])
  @@index([publishedAt])
  @@index([platformId])
  @@map("creator_content")
}

enum ContentType {
  POST
  STORY
  REEL
  VIDEO
  SHORT
  CAROUSEL
  LIVE
  TWEET
  THREAD
}

// ═══════════════════════════════════════════════════════════════════════════
// DASHBOARD BUILDER & CLIENT INSTANCES
// ═══════════════════════════════════════════════════════════════════════════

// Customizable dashboards for clients
model Dashboard {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identity
  name            String
  description     String?
  slug            String?  // For URL: /dashboards/:slug

  // Configuration
  isDefault       Boolean  @default(false)  // Default dashboard for org
  isPublished     Boolean  @default(false)  // Visible to clients
  isTemplate      Boolean  @default(false)  // Can be cloned

  // Layout configuration (react-grid-layout compatible)
  layout          Json     @default("[]")   // [{i, x, y, w, h, minW, minH}]

  // Theme/Branding overrides
  theme           Json     @default("{}")   // {primaryColor, logoUrl, etc.}

  // Relations
  widgets         DashboardWidget[]
  clientInstances ClientInstance[]

  // Access control
  visibility      DashboardVisibility @default(PRIVATE)
  allowedRoles    String[]  // Role names that can view

  // Audit
  createdById     String
  createdBy       User     @relation("DashboardCreator", fields: [createdById], references: [id])

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  @@index([organizationId])
  @@index([visibility])
  @@index([isTemplate])
  @@map("dashboards")
}

enum DashboardVisibility {
  PRIVATE       // Only creator
  ORGANIZATION  // All org members
  CLIENT        // Client instance users
  PUBLIC        // Anyone with link (view-only)
}

// Individual widgets on a dashboard
model DashboardWidget {
  id              String   @id @default(cuid())
  dashboardId     String
  dashboard       Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // Widget identity
  type            WidgetType
  title           String
  description     String?

  // Position in grid (react-grid-layout)
  x               Int      @default(0)
  y               Int      @default(0)
  width           Int      @default(4)
  height          Int      @default(3)
  minWidth        Int?
  minHeight       Int?

  // Data configuration
  dataSource      Json     @default("{}")   // {type, query, filters, refresh}
  // Example: {type: "bigquery", query: "campaign_performance", filters: {dateRange: "last30days"}}

  // Visualization configuration
  visualization   Json     @default("{}")   // {chartType, colors, labels, legend}
  // Example: {chartType: "line", xAxis: "date", yAxis: "spend", showLegend: true}

  // Filters (can be overridden by user)
  filters         Json     @default("[]")   // [{field, operator, value, userEditable}]

  // Permissions
  requiredRole    String?  // Minimum role to view this widget
  isHidden        Boolean  @default(false)

  // Interactivity
  isDrillDown     Boolean  @default(false)  // Can click for details
  drillDownConfig Json?    // Where to navigate on click

  // Refresh settings
  refreshInterval Int?     // Seconds between auto-refresh

  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([dashboardId])
  @@index([type])
  @@map("dashboard_widgets")
}

enum WidgetType {
  // KPI & Numbers
  KPI_CARD           // Single metric with trend
  SPARKLINE          // Mini line chart
  GAUGE              // Progress/goal gauge
  COUNTER            // Animated counter

  // Charts
  LINE_CHART
  BAR_CHART
  PIE_CHART
  DONUT_CHART
  AREA_CHART
  STACKED_BAR
  COMBO_CHART        // Bar + Line

  // Tables & Lists
  DATA_TABLE         // Full data table
  LEADERBOARD        // Ranked list
  ACTIVITY_FEED      // Timeline of events

  // Specialized
  HEATMAP
  FUNNEL
  SCATTER_PLOT
  GEO_MAP

  // Module-specific
  CAMPAIGN_LIST      // Campaign summary cards
  CREATOR_ROSTER     // Creator cards with metrics
  AD_ACCOUNT_STATUS  // Account connection status
  SPEND_TRACKER      // Budget vs actual
  PLATFORM_COMPARE   // Cross-platform comparison

  // Content
  TEXT_BLOCK         // Markdown/rich text
  IMAGE              // Static image
  EMBED              // External embed (Looker, etc.)
}

// Client-facing dashboard instances
model ClientInstance {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identity
  name            String
  slug            String   @unique  // URL: [slug].spokestack.app

  // Branding
  logo            String?
  primaryColor    String?
  secondaryColor  String?
  favicon         String?

  // Module configuration
  enabledModules  String[] // ["MEDIA_BUYING", "ANALYTICS", "LISTENING"]

  // Default dashboard
  defaultDashboardId String?
  defaultDashboard   Dashboard? @relation(fields: [defaultDashboardId], references: [id], onDelete: SetNull)

  // Settings
  settings        Json     @default("{}")
  // Example: {timezone: "Asia/Dubai", currency: "AED", dateFormat: "DD/MM/YYYY"}

  // Relations
  users           ClientInstanceUser[]

  // Soft delete
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([slug])
  @@map("client_instances")
}

// Users with access to client instances
model ClientInstanceUser {
  id                String   @id @default(cuid())
  clientInstanceId  String
  clientInstance    ClientInstance @relation(fields: [clientInstanceId], references: [id], onDelete: Cascade)
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Role in this client instance
  role              ClientRole @default(VIEWER)

  // Granular permission overrides
  permissions       String[]  // e.g., ["view_spend", "export_data", "manage_users"]

  // Module-specific access
  moduleAccess      Json     @default("{}")
  // Example: {MEDIA_BUYING: "full", ANALYTICS: "view", LISTENING: "none"}

  // Invitation tracking
  invitedById       String?
  invitedAt         DateTime?
  acceptedAt        DateTime?

  // Status
  isActive          Boolean  @default(true)
  lastAccessAt      DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([clientInstanceId, userId])
  @@index([clientInstanceId])
  @@index([userId])
  @@map("client_instance_users")
}

enum ClientRole {
  ADMIN      // Full access to client instance
  MANAGER    // Can edit dashboards, manage team
  EDITOR     // Can modify data, create reports
  VIEWER     // Read-only access
}

// Dashboard templates for quick setup
model DashboardTemplate {
  id              String   @id @default(cuid())

  // Identity
  name            String
  description     String?
  category        String?  // "Media Buying", "Analytics", "Listening"
  thumbnail       String?

  // Template configuration (full dashboard config)
  config          Json     // Complete dashboard + widgets config

  // Usage tracking
  usageCount      Int      @default(0)

  // Visibility
  isPublic        Boolean  @default(true)   // Available to all orgs
  organizationId  String?  // If org-specific

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([category])
  @@index([isPublic])
  @@map("dashboard_templates")
}

// ═══════════════════════════════════════════════════════════════════════════
// SYSTEM TABLES
// ═══════════════════════════════════════════════════════════════════════════

// Webhook events for debugging/replay
model SocialWebhookEvent {
  id              String   @id @default(cuid())
  source          String   // "phyllo", "stripe", "meta", etc.
  eventType       String
  payload         Json
  signature       String?

  processed       Boolean  @default(false)
  processedAt     DateTime?
  error           String?

  createdAt       DateTime @default(now())

  @@index([source, eventType])
  @@index([processed])
  @@index([createdAt])
  @@map("social_webhook_events")
}

// Data sync jobs for monitoring
model SocialSyncJob {
  id              String   @id @default(cuid())
  type            String   // "phyllo_metrics", "bigquery_sync", etc.
  status          SyncStatus

  startedAt       DateTime @default(now())
  completedAt     DateTime?

  recordsProcessed Int     @default(0)
  errors          Json[]   @default([])

  metadata        Json     @default("{}")

  @@index([type, status])
  @@index([startedAt])
  @@map("social_sync_jobs")
}
